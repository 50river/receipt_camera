# receipt_camera
# 要件定義書 (Requirements)

## 1. 背景・目的
本アプリは領収書画像をアップロードし、自動的に四隅を検出して補正したうえでOCRを実行することで、領収書に記載の「日付」「金額」「支払先」「摘要」「備考」等を自動的に取り出しやすくし、ユーザーの入力作業を効率化することを目的とします。  
特に金額項目では複数の領収金額を足し引きできる機能を提供し、複数行の金額合計を簡単に確認・編集できるようにします。

## 2. 対象範囲
- **対象ファイル形式**: JPEG, PNG 等の一般的な画像フォーマット  
- **対象デバイス**: PC、モバイル端末などブラウザ環境全般  

## 3. 利用想定シナリオ
1. ユーザーが領収書画像をアップロードする。  
2. アプリが自動で領収書の四隅を検出し、補正後の画像を生成する。必要に応じてユーザーが四隅をドラッグで調整し確定する。  
3. 画像を確認し、必要に応じて回転・反転で正しい向きに整える。  
4. 画面を切り替え、OCRを実行。画像を上下二つに分割して並列に処理し、より効率的にテキスト検出を行う。  
5. OCR結果は単語ごとにグループ化され、赤枠で表示される。ユーザーはクリックまたはタップで該当領域を選択し、内容を確認・修正して入力フォームに反映する。  
   - **金額項目がアクティブ**の場合は、足し算・引き算が可能なダイアログを用いて計算式を作成できる。  
   - **その他項目がアクティブ**の場合は、シンプルダイアログで文字列を入力しOKボタンで反映する。  
6. 計算結果は備考欄に計算式として自動的に記録できる。  

## 4. 機能要件

### 4.1. 画像アップロード
- **必須**: `<input type="file">` でユーザーが画像ファイルを選択できる。  
- **必須**: 画像をブラウザ上で `FileReader` などを使い表示する。

### 4.2. 自動切り出し＆補正
- **必須**: OpenCV.js を使い、Cannyエッジ検出 → 輪郭抽出で領収書の四隅を推定。  
- **必須**: 見つからない場合はデフォルトの枠を設定する。  
- **必須**: ユーザーによるドラッグ操作で四隅の位置を調整可。  
- **必須**: 確定した四隅に基づき `warpPerspective` で補正画像を生成する。  

### 4.3. 画像回転・反転
- **必須**: 補正画像を 90° 回転、-90° 回転、左右反転できる。  
- **必須**: 回転・反転後の画像が次のOCR処理画面に反映される。

### 4.4. 全体OCR（並列処理）
- **必須**: Tesseract.js によるOCRを、画像を上下に 2 分割して並列実行し、進捗状況をカスタムプログレスバーで表示する。  
  - 進捗バーは `#ocrProgressOverlay` 内で、上半分の緑バー(`ocrProgressTop`)と下半分の青バー(`ocrProgressBottom`)を縦方向に更新。

### 4.5. テキストグループ化
- **必須**: OCR結果を行方向 (縦) → 列方向 (横) の 2 段階でグループ化し、赤枠で表示する。  
- **必須**: ユーザーはこの赤枠をクリックして、金額またはその他項目のダイアログを表示できる。

### 4.6. ダイアログ操作
- **金額用ダイアログ (`calcDialog`)**  
  - **必須**: OCR結果をもとにした初期値を表示し、「＋」「－」で式に追加。  
  - **必須**: 「＝」を押下すると合計が算出され、`amountField` に反映する。  
  - **必須**: 複数金額の合算や差し引きが生じた場合、備考欄(`noteField`)に最終計算式を自動入力。  
- **シンプルダイアログ (`simpleDialog`)**  
  - **必須**: 金額以外のフィールド向け。OCR結果を初期値とし、ユーザーが修正しOKボタンで反映する。  

### 4.7. 入力フォーム
- **必須**: 日付、金額、支払先、摘要、備考の5項目。  
- **必須**: 項目がフォーカスされている状態で赤枠をクリックすると、その項目用ダイアログが立ち上がる。  

### 4.8. フィールドリセット
- **必須**: フィールド情報（選択領域・グループOCR結果・計算式など）を初期化するボタン。  
- **必須**: プログレスバーも初期化し、再OCRに備える。

### 4.9. 和暦変換・囲み数字変換
- **必須**: OCR結果に含まれる和暦表現（令和/平成/昭和）を自動で西暦に変換。  
- **必須**: 囲み数字（①, ② など）を通常の数字に置き換え。  

## 5. 非機能要件

### 5.1. パフォーマンス
- 2分割OCRによりある程度処理速度を向上。  
- スマホなどリソースが限られた環境でも実用的に動作することを想定。

### 5.2. 信頼性・可用性
- 画像処理やOCRに失敗してもアプリが停止しない。  
- エラー時は console とユーザーへのメッセージ表示で通知。

### 5.3. ユーザビリティ
- シンプルなUIで、ダイアログや計算式の操作が直感的にできるようにする。  
- スマートフォン操作を念頭におき、ボタンの大きさやレイアウトを調整。

### 5.4. 保守性
- OpenCV.js や Tesseract.js のバージョンアップによる影響を最小化するため、画像処理とOCR処理ロジックを分離。  
- ダイアログ操作・計算処理もモジュール的にまとめておく。

## 6. 関連システム・連携要件
- 本アプリ単体での使用が基本。  
- 将来的に外部システムへデータ連携（API送信やCSV出力）を見込む場合には拡張しやすい設計を考慮する。

## 7. 制約
- ブラウザの種類・バージョン、デバイス性能に依存する。  
- 解像度の大きい画像や複雑な文字配置では処理速度が低下する可能性がある。

## 8. 今後の拡張予定
- 多枚数の領収書をまとめて一括処理する機能。  
- 領収書の種類を推定し、レイアウトごとに最適化された切り出しやOCRパラメータを適用する機能。  

---

# 設計書 (Design)

## 1. アーキテクチャ概要
- **フロントエンドのみ**: HTML, CSS, JavaScript  
- **主なライブラリ**:  
  - [OpenCV.js](https://docs.opencv.org/) (自動切り出し, 透視変換, 二値化など)  
  - [Tesseract.js](https://github.com/naptha/tesseract.js) (OCR処理)  
- **構成**:  
  - 「画像切り出し＆補正」画面 (screen1)  
  - 「フィールド選択＆OCR」画面 (screen2)  
  - 計算用ダイアログ (金額用) とシンプルダイアログ (金額以外)  
  - カスタムプログレスバーでOCR進捗を可視化  

## 2. 画面設計

### 2.1. 画面1: 画像切り出し＆補正
1. **`imageInput`**: `<input type="file">` でユーザーが画像ファイルを選択  
2. **`pcCanvas`**: アップロードされた画像を表示し、四隅をドラッグで調整  
3. **`autoCropButton`**: 自動四隅検出ボタン  
4. **`confirmPointsButton`**: 四隅を確定して透視変換  
5. **`correctedImage`**: 透視変換後の画像プレビュー  
6. **`transformControls`**: Rotate・FlipボタンをまとめたUI  
7. **`nextToScreen2`**: 画面2へ遷移  

### 2.2. 画面2: フィールド選択＆OCR
1. **カスタムプログレスバー (`#ocrProgressOverlay`)**: 上半分と下半分のバーを縦に表示
2. **`fsCanvas`**: 補正画像を表示し、OCR結果の赤枠を描画  
3. **フィールド入力**:  
   - `dateField` (日付)  
   - `amountField` (金額)  
   - `payeeField` (支払先)  
   - `descriptionField` (摘要)  
   - `noteField` (備考)  
4. **計算式・合計表示**: 金額フィールド下に合計式と合計値を表示 (`#amountExpression`, `#amountTotalDisplay`)  
5. **`fsResetButton`**: ユーザーが選択した領域や計算情報をリセット  
6. **`ocrWholeButton`**: 全体OCR実行  
7. **`backToScreen1`**: 画面1へ戻る  

### 2.3. ダイアログ
1. **計算用ダイアログ (`calcDialog`)**  
   - OCR結果を表示する画像サムネイル  
   - テキストボックス (`calcDialogValue`)  
   - 「＋」「－」「＝」「キャンセル」ボタン  
2. **シンプルダイアログ (`simpleDialog`)**  
   - OCR結果を表示する画像サムネイル  
   - テキストボックス (`simpleDialogValue`)  
   - 「OK」「キャンセル」ボタン  

## 3. データフロー

1. **画像選択** → `pcCanvas` に描画 → 自動または手動で四隅を調整  
2. **透視変換** → `correctedImage` + `fsImage` に補正後の画像を反映 → 回転・反転操作可  
3. **OCR実行 (2分割処理)**  
   1. 画像を上下に分割  
   2. それぞれ Tesseract.js で並列に認識させ、進捗をカスタムプログレスバーで更新  
   3. 結果をマージし、`lastOcrData` として保持  
4. **グループ化** → 赤枠情報 (`lastGroupBoxes`) を算出 → `fsCanvas` へ描画  
5. **ユーザークリック** → 金額用 or シンプルダイアログ  
   - **金額ダイアログ**: `calcSequence` に値を追加し最終合計を `amountField` に反映。必要に応じて備考欄に計算式も残す。  
   - **シンプルダイアログ**: OCR文字列を確認してOKで対象フィールドに反映。  
6. **リセット** → フィールド・グループ情報を初期化し、プログレスバーも初期値に戻す  

## 4. 主要モジュール設計

1. **AutoCropModule**
   - `autoCrop()`: OpenCV.js の Cannyエッジ検出 + findContours で四隅推定  
   - `orderPoints()`: 四隅の順序を (左上, 右上, 右下, 左下) に並び替え  
   - 透視変換 (warpPerspective) で補正画像生成  

2. **TransformModule**
   - `rotateImage(dataURL, angle)`: 画像を指定角度で回転  
   - `flipImage(dataURL)`: 画像を左右反転  

3. **OcrModule**
   - `ocrImageInTwoSegments(image)`: 画像を上下に分割して並列OCR  
   - `performOCROnField(field, region)`: 部分OCR (金額など)

4. **GroupingModule**
   - 傾き計算 (`computeAverageTilt`) → 回転補正  
   - 行グループ (`groupWordsByLineTilt`) → 列グループ (`groupWordsHorizontally`)  
   - 最終的にボックス情報 (x, y, width, height) を算出  

5. **DialogController**
   - 計算用ダイアログ (`calcDialog`) の開閉、足し引き演算 (`calcSequence` 管理)  
   - シンプルダイアログ (`simpleDialog`) の開閉、テキスト反映  

6. **UIController**
   - 画面切り替え (`showScreen`)  
   - キャンバス描画 (`drawPcCanvasWithPoints`, `drawFsCanvas`)  
   - カスタムプログレスバー (`updateCustomProgressBar`)  

## 5. インタフェース

1. **HTML要素との紐づけ**
   - `document.getElementById` でイベントリスナーを設定  
   - 例: `autoCropButton.addEventListener('click', autoCrop)`  

2. **外部API・ライブラリ**
   - **OpenCV.js**: `cv.Canny`, `cv.findContours`, `cv.warpPerspective` 等  
   - **Tesseract.js**: `Tesseract.createWorker()`, `.recognize()`  
   - **Canvas要素**: `<canvas>` に対する描画、 `toDataURL()` で画像化  

## 6. 例外・エラー処理
- 画像未選択で自動切り出し → アラート表示  
- OCRや画像処理中にエラー → `console.error` および必要に応じてアラートを表示  
- 四隅が検出できなかった場合 → デフォルト枠を設定し、ユーザーの手動修正に任せる  

## 7. テスト観点

1. **機能テスト**
   - 四隅検出が正しく動作するか  
   - 2分割したOCR結果が正常にマージされ、赤枠が出るか  
   - 金額ダイアログで複数加減計算を行った場合の合計計算

2. **UIテスト**
   - PC・スマホの両方で、クリックやタップ操作が問題なく動作するか  
   - ダイアログが最前面に表示され、操作しやすいか

3. **パフォーマンステスト**
   - 大きなサイズの画像や大量の文字を含む画像を処理してもブラウザがフリーズしないか  
   - カスタムプログレスバーがほぼリアルタイムに進捗を示すか

4. **計算機能テスト**
   - 「＋」「－」「＝」ボタンの順番を変えても意図した計算結果が得られるか  
   - 備考欄に計算式が自動で書き込まれるか

## 8. 運用・保守
- ライブラリ(OpenCV.js / Tesseract.js)のアップデート時は動作検証を実施
- 要件追加（例: 多枚数連続処理, レイアウト自動判定）への対応を考慮し、関数をシンプルに保つ

## 9. テスト実行方法
```
node tests/app.test.js
```
上記コマンドを実行すると、基本的なユーティリティ関数のテストが走ります。
